<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Copilot-Style Chat</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f3f3f3;
    }
    #thinkingMessage {
  background-color: #FFF3CD; /* Soft yellow for status */
  color: #856404;
  font-style: italic;
  bottom: 0;
  left: 0;
  border: 1px solid #FFECB5;
}


    .chat-container {
      max-width: 600px;
      margin: 50px auto;
      display: flex;
      flex-direction: column;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      height: 90vh;
      overflow: hidden;
    }

    .chat-header {
      background: #0078D4;
      color: white;
      padding: 20px;
      font-size: 1.2em;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      position:relative;
      flex-direction: column;
    }

    .message {
      max-width: 80%;
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      position: relative;
    }

    .user {
      background-color: #E1ECF4;
      align-self: flex-end;
    }

    .bot {
      background-color: #F4F4F4;
      align-self: flex-start;
    }

    .chat-input {
      display: flex;
      padding: 15px;
      border-top: 1px solid #ddd;
    }

    input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      margin-left: 10px;
      padding: 10px 15px;
      background-color: #0078D4;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
  <style>
    <link rel="stylesheet" href="/css/trustgrid-form.css"/>
    <style>
        /* Add minimal styling or refer your existing CSS */
        body { font-family: Arial, sans-serif; margin: 20px; }
        label, input, button { font-size: 1rem; margin-bottom: 10px; }
        button {
          cursor: pointer; padding: 6px 12px;
          background-color: #0078d7; color: white; border: none; border-radius: 4px;
        }
        button:hover { background-color: #005ea9; }
        .loan-details {
          margin-top: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 6px; max-width: 700px;
        }
        .loan-item {
          border-bottom: 1px solid #eee; padding: 10px 0;
        }
        .loan-item:last-child { border-bottom: none; }
        .flag-true { color: red; font-weight: bold; }
        .flag-false { color: green; font-weight: bold; }

        table {
  font-family: Arial, sans-serif;
  font-size: 14px;
}

th, td {
  padding: 8px 12px;
}

th {
  text-align: left;
}

  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">Copilot Chat</div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input">
    <input type="text" id="messageInput" placeholder="Type your message..." />
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <!-- SVG Icon + Hidden File Input -->
    <label for="fileInput" style="display: flex; align-items: center; cursor: pointer;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="#555">
        <path d="M12 2C8.13 2 5 5.13 5 9v10a3 3 0 006 0V9a1 1 0 10-2 0v10a1 1 0 01-2 0V9a5 5 0 0110 0v10a3 3 0 01-6 0V9a1 1 0 112 0v10a1 1 0 002 0V9c0-3.87-3.13-7-7-7z"/>
      </svg>
    </label>
    <input type="file" id="fileInput" style="display: none;" accept=".pdf" />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
  const sendBtn = document.getElementById("sendBtn");
  const messageInput = document.getElementById("messageInput");
  const chatMessages = document.getElementById("chatMessages");
  function showThinkingMessage() {
    // Remove any existing thinking message if present
    removeThinkingMessage();

    const msg = document.createElement("div");
    msg.classList.add("message", "bot");
    msg.id = "thinkingMessage";
    msg.textContent = "I'm thinking on that... ðŸ¤”";
    if(isDivScrollable(chatMessages)){
        msg.style.position = "block"
    }else{
        msg.style.position = "absolute"
    }

    chatMessages.appendChild(msg);

    chatMessages.scrollTop = chatMessages.scrollHeight; // auto-scroll
  }
  function isDivScrollable(div) {
  return div.scrollHeight > div.clientHeight || div.scrollWidth > div.clientWidth;
}
function removeThinkingMessage() {
  const thinkingMsg = document.getElementById("thinkingMessage");
  if (thinkingMsg) {
    thinkingMsg.remove();
  }
}
  function addMessage(content, sender) {
    const msg = document.createElement("div");
    msg.classList.add("message", sender);
    msg.textContent = content;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  function addHtmlMessage(htmlContent, sender) {
    const msg = document.createElement("div");
    msg.classList.add("message", sender);
    msg.innerHTML = htmlContent;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  sendBtn.onclick = () => {

    const userInput = messageInput.value.trim();
    if (userInput) {
      addMessage(userInput, "user");
      showThinkingMessage();
      messageInput.value = "";
      ui = userInput.toLowerCase();
      if(isLoanIntent(ui)){
        let loanApplyRequestBody = extractLoanData(userInput);
        console.log(loanApplyRequestBody);
        // HTTP HIT
        const csrfToken = document.querySelector('input[name="_csrf"]').value;
        fetch('/loan/apply', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
              pan: loanApplyRequestBody.pan,
              amount: loanApplyRequestBody.amount,
              lender: loanApplyRequestBody.lender
            })
          })
          .then(response => response.text())
          .then(data => {
            console.log("Loan submitted:", data);
              setTimeout(() => {
                addMessage(data, "bot");
                removeThinkingMessage();
              }, 700);
          })
          .catch(err => {
            console.error("Submission error:", err);
            setTimeout(() => {
                addMessage("ðŸ”§ System hiccup! Totally on our side. Please give it another try while we untangle things.", "bot");
                removeThinkingMessage();
              }, 700);

          });

          return;
      }
      console.log(isLoanFetchIntent(ui));
      if(isLoanFetchIntent(ui)){
          let pan = extractPAN(userInput);
          console.log(pan);
          fetch(`/api/loan/listWithAlert?pan=${encodeURIComponent(pan)}`)
            .then(response => response.text())
            .then(data => {
              console.log("Loan details fetched:", data);
              data = JSON.parse(data);
              let html = `<p><b>Stack Alert Generated:</b> ${data.stackAlertGenerated ? '<span style="color:red;font-weight:bold;">Yes</span>' : '<span style="color:green;font-weight:bold;">No</span>'}</p>`;
              html += `<p><b>Risk Free Amount:</b> â‚¹${data.riskFreeAmount}</p>`;

              if (data.loans && data.loans.length > 0) {
                html += "<h3>Loan Applications:</h3>";
                html += `<table border="1" cellspacing="0" cellpadding="8" style="border-collapse: collapse; width: 100%; max-width: 700px;">
                  <thead style="background-color: #0078d7; color: white;">
                    <tr>
                      <th>ID</th>
                      <th>Amount (â‚¹)</th>
                      <th>Status</th>
                      <th>Applied On</th>
                      <th>Lender</th>
                      <th>Alert Generated</th>
                    </tr>
                  </thead>
                  <tbody>`;

                data.loans.forEach(loan => {
                  html += `<tr>
                    <td>${loan.id}</td>
                    <td style="text-align: right;">${loan.amount.toLocaleString()}</td>
                    <td>${loan.status}</td>
                    <td>${loan.appliedOn}</td>
                    <td>${loan.lender}</td>
                    <td style="color:${loan.alertGenerated ? 'red' : 'green'}; font-weight:bold;">
                      ${loan.alertGenerated ? 'Yes' : 'No'}
                    </td>
                  </tr>`;
                });

                html += "</tbody></table>";
                } else {
                html += "<p>No loan applications found.</p>";
              }
              setTimeout(() => {
                    addHtmlMessage(html, "bot");
                    removeThinkingMessage();
                  }, 1200);


            })
            .catch(err => {
              console.error("Fetch error:", err);
              setTimeout(() => {
                addMessage("ðŸ”§ Whoops! Couldn't grab loan details right now. Try again in a bit!", "bot");
                removeThinkingMessage();
              }, 700);
            });


          return;
      }
      setTimeout(() => {
                addMessage("Hello! How May I Help You?", "bot");
                removeThinkingMessage();
              }, 700);

    }
  };
  function extractPAN(text) {
    const panRegex = /\b([A-Z]{5}[0-9]{4}[A-Z])\b/g;
    const matches = text.match(panRegex);
    return matches || [];
  }
  function isLoanIntent(ui) {
    const intentKeywords = ["want", "require", "apply", "looking", "need"];
    const normalizedUI = ui.toLowerCase();
    return intentKeywords.some(keyword => normalizedUI.includes(keyword));
  }
  function isLoanFetchIntent(input) {
    const intentRegex = /\b(fetch|get|retrieve)\b.*\b(loan|PAN)\b/i;

    return intentRegex.test(input);
  }
  function extractLoanData(text) {
    const panMatch = text.match(/\b([A-Z]{5}[0-9]{4}[A-Z])\b/i);
    const panNumber = panMatch?.[1]?.toUpperCase() || null;
    const cleanText = panNumber ? text.replace(panNumber, '').replace(/[â‚¹,]/g, '') : text.replace(/[â‚¹,]/g, '');

    // Match phrases that express loan intent
      const amountMatch = cleanText.match(/\b(\d+(?:\.\d{1,2})?)\s*(l|lakh|lakhs|cr|crore|crores)?\b/i);
let loanAmount = null;
if (amountMatch?.[1]) {
  loanAmount = parseFloat(amountMatch[1].replace(/,/g, ''));
  const unit = amountMatch[2]?.toLowerCase();

  switch (unit) {
    case 'l':
    case 'lakhs':
      loanAmount *= 100000;
      break;
    case 'lakh':
      loanAmount *= 100000;
      break;
    case 'cr':
    case 'crore':
      loanAmount *= 10000000;
      break;
    case 'crores':
      loanAmount *= 10000000;
      break;
    case 'rupees':
    case 'loan':
    case undefined:
      // Use plain value, no multiplication
      break;
  }
}

const bankMatch = text.match(/\b(?:from|bank\s*(?:is|:)?)(?:\s+)?([A-Z]{2,}(?:\s+[A-Z]{2,})*)/i);
const bankName = bankMatch?.[1] || null;

return {
  pan: panMatch?.[1] || null,
  amount: loanAmount || null,
  lender: bankName
};
}

</script>
</body>
</html>
