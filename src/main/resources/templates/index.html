<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Copilot-Style Chat</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f3f3f3;
    }

    .chat-container {
      max-width: 600px;
      margin: 50px auto;
      display: flex;
      flex-direction: column;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      height: 90vh;
      overflow: hidden;
    }

    .chat-header {
      background: #0078D4;
      color: white;
      padding: 20px;
      font-size: 1.2em;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 80%;
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 15px;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      position: relative;
    }

    .user {
      background-color: #E1ECF4;
      align-self: flex-end;
    }

    .bot {
      background-color: #F4F4F4;
      align-self: flex-start;
    }

    .chat-input {
      display: flex;
      padding: 15px;
      border-top: 1px solid #ddd;
    }

    input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      margin-left: 10px;
      padding: 10px 15px;
      background-color: #0078D4;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">Copilot Chat</div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input">
    <input type="text" id="messageInput" placeholder="Type your message..." />
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <!-- SVG Icon + Hidden File Input -->
    <label for="fileInput" style="display: flex; align-items: center; cursor: pointer;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="#555">
        <path d="M12 2C8.13 2 5 5.13 5 9v10a3 3 0 006 0V9a1 1 0 10-2 0v10a1 1 0 01-2 0V9a5 5 0 0110 0v10a3 3 0 01-6 0V9a1 1 0 112 0v10a1 1 0 002 0V9c0-3.87-3.13-7-7-7z"/>
      </svg>
    </label>
    <input type="file" id="fileInput" style="display: none;" accept=".pdf" />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
  const sendBtn = document.getElementById("sendBtn");
  const messageInput = document.getElementById("messageInput");
  const chatMessages = document.getElementById("chatMessages");

  function addMessage(content, sender) {
    const msg = document.createElement("div");
    msg.classList.add("message", sender);
    msg.textContent = content;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  function addHtmlMessage(htmlContent, sender) {
    const msg = document.createElement("div");
    msg.classList.add("message", sender);
    msg.innerHTML = htmlContent;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  sendBtn.onclick = () => {
    const userInput = messageInput.value.trim();
    if (userInput) {
      addMessage(userInput, "user");
      messageInput.value = "";
      ui = userInput.toLowerCase();
      if(isLoanIntent(ui)){
        let loanApplyRequestBody = extractLoanData(userInput);
        console.log(loanApplyRequestBody);
        // HTTP HIT
        const csrfToken = document.querySelector('input[name="_csrf"]').value;
        fetch('/loan/apply/submit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
              pan: loanApplyRequestBody.pan,
              amount: loanApplyRequestBody.amount,
              lender: loanApplyRequestBody.lender,
              _csrf: csrfToken // Include token here
            })
          })
          .then(response => response.text())
          .then(data => {
            console.log("Loan submitted:", data);
          })
          .catch(err => {
            console.error("Submission error:", err);
          });
      }
      setTimeout(() => {
        addMessage("Got it! I'm thinking on that... ðŸ¤”", "bot");
      }, 700);
    }
  };

  function isLoanIntent(ui) {
    const intentKeywords = ["want", "require", "apply", "looking", "need"];
    const normalizedUI = ui.toLowerCase();
    return intentKeywords.some(keyword => normalizedUI.includes(keyword));
  }
  function extractLoanData(text) {
    const panMatch = text.match(/\b([A-Z]{5}[0-9]{4}[A-Z])\b/i);
    const panNumber = panMatch?.[1]?.toUpperCase() || null;
    const cleanText = panNumber ? text.replace(panNumber, '').replace(/[â‚¹,]/g, '') : text.replace(/[â‚¹,]/g, '');

    // Match phrases that express loan intent
      const amountMatch = cleanText.match(/\b(\d+(?:\.\d{1,2})?)\s*(l|lakh|lakhs|cr|crore|crores)?\b/i);
let loanAmount = null;
if (amountMatch?.[1]) {
  loanAmount = parseFloat(amountMatch[1].replace(/,/g, ''));
  const unit = amountMatch[2]?.toLowerCase();

  switch (unit) {
    case 'l':
    case 'lakhs':
      loanAmount *= 100000;
      break;
    case 'lakh':
      loanAmount *= 100000;
      break;
    case 'cr':
    case 'crore':
      loanAmount *= 10000000;
      break;
    case 'crores':
      loanAmount *= 10000000;
      break;
    case 'rupees':
    case 'loan':
    case undefined:
      // Use plain value, no multiplication
      break;
  }
}

const bankMatch = text.match(/\b(?:from|bank\s*(?:is|:)?)(?:\s+)?([A-Z]{2,}(?:\s+[A-Z]{2,})*)/i);
const bankName = bankMatch?.[1] || null;

return {
  pan: panMatch?.[1] || null,
  amount: loanAmount || null,
  lender: bankName
};
}

</script>
</body>
</html>
